---
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggthemes)
library(ghibli)
```

This is the code behind an analysis of the "Incarceration Trends" dataset from the [#tidytuesday project](https://github.com/rfordatascience/tidytuesday/tree/master/data/2019/2019-01-22).

```{r}
pretrial_pop <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-01-22/pretrial_population.csv")

prison_pop <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-01-22/prison_population.csv")
```


```{r}

top_states <- pretrial_pop %>%
  filter(pop_category == "Total",
         year == 2015) %>% 
  na.omit() %>%
  group_by(state) %>%
  summarize(rate_per_100000 = sum(pretrial_population)/sum(population) * 100000) %>%
  arrange(rate_per_100000) %>%
  head(5) %>%
  select(state)
  
  
pretrial_pop %>%
  filter(state %in% as.vector(top_states$state),
         pop_category == "Total",
         year >= 1990) %>% 
  group_by(year, state) %>%
  na.omit() %>%
  summarize(rate_per_100000 = sum(pretrial_population)/sum(population) * 100000) %>%
  ggplot(aes(x = year, y = rate_per_100000, col = state)) +
  geom_line() +
  theme_light() +
  theme(legend.key.size = unit(12,"pt"))

  
  
```



Specific states

```{r}

pretrial_pop %>%
  filter(state == c("UT", "KY"),
         pop_category == "Total",
         year >= 1990) %>% 
  group_by(year, state) %>%
  na.omit() %>%
  summarize(rate_per_100000 = sum(pretrial_population)/sum(population) * 100000) %>%
  ggplot(aes(x = year, y = rate_per_100000, col = state)) +
  geom_line() +
  theme_light() +
  theme(legend.key.size = unit(12,"pt"))

```
















Let's look at PA.

```{r}
pa <- pretrial_pop %>%
  filter(state == "PA",
         pop_category == "Total") %>%
  na.omit() %>% 
  group_by(year, urbanicity) %>%
  summarize(rate_per_100000 = sum(pretrial_population)/sum(population) * 100000,
            sum_pop = sum(population),
            sum_pretrial = sum(pretrial_population)) %>% 
  mutate(place = "PA")

pa %>%
  ggplot(aes(x = year, y = rate_per_100000, col = urbanicity, size = sum_pop)) +
  geom_path(lineend="round",linejoin="mitre") +
  theme_light() +
  scale_color_manual(values = ghibli_palette("KikiMedium",n=5)[2:5])+ 
  theme(legend.key.size = unit(12,"pt")) + 
  guides(colour = guide_legend(override.aes = list(size = 2))) +
  theme_fivethirtyeight()

pa %>%
  ggplot(aes(x = year, y = sum_pretrial)) +
  geom_area(aes(fill = urbanicity), position = "stack") +
  theme_light() +
  scale_color_manual(values = ghibli_palette("KikiMedium",n=5)[2:5])+ 
  theme(legend.key.size = unit(12,"pt")) + 
  guides(colour = guide_legend(override.aes = list(size = 2))) +
  theme_fivethirtyeight()

```


```{r}

pre <- pretrial_pop %>%
  rename("in_pop" = "pretrial_population") %>%
  mutate(type = "pretrial")

pris <- prison_pop %>%
  rename("in_pop" = "prison_population") %>%
  mutate(type = "prison")

pop <- rbind(pre, pris)

pa_both <- pop %>%
  filter(state == "PA",
         pop_category == "Total") %>%
  na.omit() %>% 
  group_by(year, urbanicity, type) %>%
  summarize(rate_per_100000 = sum(in_pop)/sum(population) * 100000,
            sum_pop = sum(population))

pa_both %>%
  ggplot(aes(x = year, y = rate_per_100000, col = urbanicity, alpha = type)) +
  geom_path(size = 2) +
  theme_light() +
  scale_color_manual(values = ghibli_palette("KikiMedium",n=5)[2:5])+ 
  theme(legend.key.size = unit(12,"pt"))

```


 
Average trend over the US.

```{r}
us <- pretrial_pop %>%
  filter(pop_category == "Total") %>%
  na.omit() %>% 
  group_by(year, urbanicity) %>% 
  summarize(rate_per_100000 = sum(pretrial_population)/sum(population) * 100000,
            sum_pop = sum(population)) %>%
  mutate(place = "US")

us %>%
  ggplot(aes(x = year, y = rate_per_100000, col = urbanicity, size = sum_pop)) +
  geom_path(lineend="round",linejoin="mitre") +
  theme_light() +
  scale_color_manual(values = ghibli_palette("KikiMedium",n=5)[2:5]) + 
  guides(colour = guide_legend(override.aes = list(size = 2))) 

```


```{r}
urban_pa <- pretrial_pop %>%
  filter(county_name %in% c("Philadelphia County","Allegheny County"),
         pop_category == "Total") %>%
  na.omit() %>% 
  group_by(year, urbanicity, county_name) %>%
  summarize(rate_per_100000 = sum(pretrial_population)/sum(population) * 100000,
            sum_pop = sum(population)) %>% 
  mutate(place = county_name)


rbind(urban_pa, us) %>%
  filter(urbanicity == "urban") %>%
  ggplot(aes(x = year, y = rate_per_100000, col = place)) +
  geom_line(size = 2) +
  theme_light() +
  scale_color_manual(values = ghibli_palette("KikiMedium",n=5)[2:4])+ 
  theme(legend.key.size = unit(12,"pt")) +
  labs(title = "Comparing pretrial jail rates for urban Pennsylvania to urban US average")

#without us avg

rbind(urban_pa) %>%
  filter(urbanicity == "urban") %>%
  ggplot(aes(x = year, y = rate_per_100000, col = place, size = sum_pop)) +
  geom_path(lineend="round",linejoin="mitre") +
  scale_color_manual(values = ghibli_palette("KikiMedium",n=5)[3:4]) +
  labs(title = "Pre-trial detention rate (per 100,000) in urban Pennsylvania") +
  theme_fivethirtyeight() +
  guides(color= FALSE,
         size = guide_legend(title = "County population:")) + 
  theme(legend.key.size = unit(2,"pt"),
        legend.text = element_text(size = 9),
        legend.title = element_text(size = 10),
        plot.title = element_text(size = 14.5)) +
  annotate("text", x = 1977, y = 240, label = "Philadelphia County", size = 4) + 
  annotate("segment", x = 1978, xend = 1977, y = 210, yend = 144) +
  annotate("text", x = 1997, y = 30, label = "Allegheny County", size = 4) + 
  annotate("segment", x = 1996, xend = 1995, y = 50, yend = 120)


```





I want to see the highest

```{r}

pretrial_pop %>%
  filter(pop_category == "Total") %>%
  na.omit() %>%
  group_by(county_name, year) %>% 
  summarize(rate_per_100000 = sum(pretrial_population)/sum(population) * 100000,
            sum_pop = sum(population)) %>%
  ungroup() %>%
  arrange(desc(rate_per_100000)) %>%
  head(10)


```











Let's look at pretrial and prison.

```{r}

pa_pretopris <- pop %>%
  filter(state == "PA",
         pop_category == "Total") %>%
  na.omit() %>% 
  group_by(year, type) %>%
  summarize(rate_per_100000 = sum(in_pop)/sum(population) * 100000,
            sum_pop = sum(population)) %>% 
  mutate(place = "PA")
  
us_pretopris <- pop %>%
  filter(pop_category == "Total") %>%
  na.omit() %>% 
  group_by(year, type) %>% 
  summarize(rate_per_100000 = sum(in_pop)/sum(population) * 100000,
            sum_pop = sum(population)) %>%
  mutate(place = "US")
  
rbind(pa_pretopris, us_pretopris) %>%
  ggplot(aes(x = year, y = rate_per_100000, col = place, alpha = type)) +
  geom_line(size = 2) +
  theme_light() +
  scale_color_manual(values = ghibli_palette("KikiMedium",n=5)[2:3])+ 
  theme(legend.key.size = unit(12,"pt")) +
  scale_alpha_discrete(range = c(1, 0.3))

  
```

And NJ.

```{r}
pretrial_pop %>%
  filter(state == "NJ",
         pop_category == "Total") %>%
  na.omit() %>% 
  group_by(year, urbanicity, pop_category) %>% 
  summarize(rate_per_100000 = sum(pretrial_population)/sum(population) * 100000,
            sum_pop = sum(population)) %>%
  ggplot(aes(x = year, y = rate_per_100000, col = urbanicity, size = sum_pop)) +
  geom_path(lineend="round",linejoin="mitre") +
  theme_light() +
  scale_color_manual(values = ghibli_palette("KikiMedium",n=5)[3:5]) + 
  guides(colour = guide_legend(override.aes = list(size = 2)))

```